

# Introduction

When making a rest calls to one of our BG microservice, a lot of distributed activity occur involving multiple microservices, different form of persistent storages and various internal and external backends such as SAP (PI or NWG), CDL, SalesForce etc. 

The `monalisa2` tool shows you all that traffic in one simple page: all related subrequests in a pretty sequence diagram; with also full requests and response content whether it is inter-service traffic, redis caching interaction, third party service data retrieval and a lot more. 

Just make your call(s) and see exactly what's happening behind the scene: failure causes, bottlenecks services, real source of the data, logs,  etc. 

Anybody can use the `monalisa2` tool: developers, testers, architects and managers. 

[btw, It's called `monalisa2` because the first version of the tool was about turning very ugly `strace`/`tcpdump` raw data into a beautiful picture (a nice sequence diagram).]

# User cases

Here is a list of typical user cases for the `monalisa2` tracing tool:

* A back-end developer investigating a bug across multiple microservices and other distributed participants
* A tester creating an issue and willing to provide as much info as possible to help reproduce the issue, especially when intermitent
* A tester who wants to automatically test that a call to X lead to 3 internal calls to Y.
* A front-end developer / journey owner who wants to understand why a back-end call is slow and whether things could work differently given the need of a journey. 
* A new starter who wants to understand how everything fits together without having to read 1000s of lines of codes. 
* An architect/manager who wants to see how a certain flow work to see if certain bits can be reused for another journey. 
* An architect who wants to find and rework bottlenecks in the system
* More to come


# How to use 

The microservice rest calls that are being tracked should be made as usual, just adding the `X-M2-Tracer` header to the request if you want to bind multiple FE requests together on the report. 

For this header, a unique value should be chosen so that the traffic extracted is not mixed up with other request, for example:

`X-M2-Tracer:CHI_Pablo_20180218_a` (use letters, numbers and _)

You can also make a call with no such header, just using the `X-B3-TraceId` header returned in the response (just check chrome developer tools traffic tab for example). 

After the calls have been made (using postman, curl or any other tool), the monalisa UI can be found here:

[Monalisa2 URL](https://digital1.bgdigitaltest.co.uk/microservices-tools/monalisa2/)

Just enter the trace header value and press RETRIEVE.

![](https://github.com/ConnectedHomes/bg-ms-interface/blob/master/docs/monalisa2/m2main.png)

The report is generated, including the sequence diagram, the requests/responses complete data, postman collections, wiremocks, etc. 

![](https://github.com/ConnectedHomes/bg-ms-interface/blob/master/docs/monalisa2/customers_noredis.png)
![](https://github.com/ConnectedHomes/bg-ms-interface/blob/master/docs/monalisa2/rr.png)

When a call fail, an `Error CT Logs` button is available for quick access to the section of the log that contain the cause of the failure. 

![](https://github.com/ConnectedHomes/bg-ms-interface/blob/master/docs/monalisa2/error1.png)
![](https://github.com/ConnectedHomes/bg-ms-interface/blob/master/docs/monalisa2/error2.png)

# Features

A typical report includes:
* sequence diagram 
* timing information
* complete data for requests/response subrequests/subresponses
* autogenerated postman collection
* autogenerated wiremocks
* autogenerated simple doc 
* error logs if relevant (check the 4xx 5xx error response to see the log button)
* ability to import/export report as json file (can be used separately in JQ, beyondcompare etc)
* ability to get all this in a web UI or as an api call
* ability to whitelist / blacklist participants (e.g.: exclude redis to make the diagram clearer for example)

Additional notes:

* It can be used as a UI report, or as an API or parsing report files. Many ways to integrate this in a workflow
* available on different environment: preprod, local, etc
* the data behind those report is typically kept only a day but those reports can be saved locally for subsequent viewing. 
* when there is interaction between microserviceA and microserviceB, it will only appear in the diagram if B is instrumented

# Future improvements

* At the moment, only certain microservices are instrumented. More to come. 
* If there are lots of traffic participants, the sequence diagram might be squashed due to WSD free use limitations, we might generate the image ourselves.
* Front end journeys could have an `X-M2-Tracer` header that mixes both a journey ID and a random user id so that when something wrong happens, it's easy t investigate the whole sequence of events that led to the bug. 
* A new tool to know for any internal/external endpoint, who called it and what result did they tend to obtain. 

# Troubleshooting

* if a microservice doesn't appear, make sure it has been instrumented properly, see link  https://github.com/ConnectedHomes/bg-rest-api/wiki/M2--Preparing-a-microservice
